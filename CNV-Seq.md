# Protocol to detect copy number variation using CNV-Seq

# Table of Contents
* [About the tool](#about-the-tool)
* [Input](#input)
  * [Hits files](#hits-file)
* [Run CNV-Seq](#cnv-seq)
* [Output](#output)

# About the tool

CNV-Seq alows the detection of copy number variation using NGS data.

# Input

In order to reduce the noise around repeat regions in the genome, we first filter reads with a mapping quality > 4: 

`samtools view -b -q 4 sample.bam > sample.qfilt.bam`

## Hits file
We only need to provide two "hits" files for CNV-Seq to work, one for the sample, and one for the reference. 

These our be generated by running the following script: 

`samtools view -F 4 sample.bam | perl -lane 'print "$F[2]\t$F[3]"' > sample.hits` 

This creates a two column, tab delimited file:

```
2L	1
2L	1
2L	4
2L	4
2L	4
2L	4
2L	4
2L	4
2L	4 
```

Here, the second column is the corresponding 1-based leftmost mapping position of that read.


Next, to select only fully assembled chromosomes run this script. This will output filtered files eg `sample.hits.filt`:

```{perl}
#/usr/bin/perl
use strict;
use warnings;
use feature qw /say/;

my @files = @ARGV;

my @keys = qw / 2L 2R 3L 3R 4 X Y /;
my %filter;
$filter{$_} = 1 for (@keys);

for my $f (@files){
open my $in, '<', $f or die $!;
open my $out, '>', "$f\.filt" or die $!;

    while(<$in>){
        chomp;
        my @split = split;
        print $out "$_\n" if $filter{$split[0]};
    }
}
```

## CNV-Seq
Now run the main perl script: 

`cnv-seq.pl --ref Hum3.hits --test Hum1.hits --genome-size 23542271`

The most interesting parameter that can be tweaked is the `	--log2-threshold`. The default is set to 0.6

## Output

This produces two files `sample-vs-reference.cnv` and `sample-vs-reference.count`

`sample-vs-reference.count` shows the raw count data for each CNV. 

`sample-vs-reference.cnv` contains the stats 

To plot all data
```{R}
library(cnv)
data <- read.delim("Hum1.hits-vs-Hum3.hits.log2-0.8.pvalue-0.001.minw-4.cnv")
plot.cnv(data, ylim = c(-8,8))
```

```{R}
for (chrom in c("X","Y")){
	plot.cnv.chr <- function (data, chromosome=chrom,
	                      from = NA, to = NA, title = paste("full coverage of",chrom, sep="")
	                      ylim = c(-4, 4), glim = c(NA, NA),
	                      xlabel = "Position (bp)")
	plot.cnv.chr
	ggsave(file = paste("HUM-1",chrom,".pdf",sep="_"))
}
```
						  
